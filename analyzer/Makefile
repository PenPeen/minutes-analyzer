MAKEFLAGS += --silent
.PHONY: help setup start build-lambda deploy-local destroy-local clean check-localstack-ready stop test test-lambda ensure-terraform-backend-bucket

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help: ## ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ç’°å¢ƒå¤‰æ•°
LOCALSTACK_ENDPOINT ?= http://localhost:4566
LOCALSTACK_TIMEOUT ?= 60
LOCALSTACK_CHECK_INTERVAL ?= 3
AWS_REGION = ap-northeast-1
PROJECT_NAME = minutes-analyzer
ENVIRONMENT = local
TF_DIR = infrastructure/environments/local

# LocalStack AWSè¨­å®š
AWS_ENDPOINT_FLAG = --endpoint-url=$(LOCALSTACK_ENDPOINT)
AWS_LOCAL_CREDENTIALS = AWS_ACCESS_KEY_ID=test AWS_SECRET_ACCESS_KEY=test

# åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆOSSå…¬é–‹ç”¨ï¼‰
setup: ## åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
	@if [ -f .env.local ]; then \
		echo "ğŸ“‹ .env.localã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ï¼ˆä¿è­·ã•ã‚Œã¦ã„ã¾ã™ï¼‰"; \
		echo "ğŸ”§ ãã®ä»–ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ç¶™ç¶šã—ã¾ã™..."; \
	else \
		./scripts/setup.sh; \
	fi
	@echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
	@if command -v bundle >/dev/null 2>&1; then \
		cd lambda && bundle install; \
	else \
		echo "âš ï¸  BundlerãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Rubyã®ä¾å­˜é–¢ä¿‚ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"; \
	fi
	@echo "âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

# é–‹ç™ºç’°å¢ƒèµ·å‹•ï¼ˆãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤å«ã‚€ï¼‰
start: ## é–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
	@echo "ğŸš€ é–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ä¸­..."
	@if [ ! -f .env.local ]; then \
		echo "âŒ .env.localãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚make setup ã‚’æœ€åˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
		exit 1; \
	fi
	@echo "ğŸ³ Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ä¸­..."
	@export $$(cat .env.local | grep -v '^#' | grep -v 'GOOGLE_SERVICE_ACCOUNT_JSON' | xargs) && \
	cd infrastructure && docker compose up -d
	@$(MAKE) wait-for-localstack
	@echo "ğŸ“ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­..."
	@$(MAKE) generate-tfvars
	@echo "ğŸ”¨ Lambdaé–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	@$(MAKE) build-lambda
	@echo "ğŸš€ ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	@$(MAKE) tf-init
	@$(MAKE) tf-apply
	@echo "ğŸ“¤ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."
	@$(MAKE) upload-prompts-local
	@echo "âœ… é–‹ç™ºç’°å¢ƒã®èµ·å‹•ãŒå®Œäº†ã—ã¾ã—ãŸ"
	@echo ""
	@echo "ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±:"
	@cd $(TF_DIR) && terraform output 2>/dev/null || echo "ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"

# terraform.tfvarsã®ç”Ÿæˆ
# 
# Google Service Account JSONã®å‡¦ç†ã«ã¤ã„ã¦:
# å½“åˆã¯BASE64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ãŸãŒã€ä»¥ä¸‹ã®ç†ç”±ã§ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆæ–¹å¼ã«å¤‰æ›´:
# 1. JSONå†…ã®æ”¹è¡Œæ–‡å­—ï¼ˆprivate_keyå†…ã®\nï¼‰ã‚’Terraformå¤‰æ•°ã¨ã—ã¦æ­£ã—ãã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹ã®ãŒè¤‡é›‘
# 2. Terraformã®tfvarsãƒ•ã‚¡ã‚¤ãƒ«ã¯è¤‡æ•°è¡Œæ–‡å­—åˆ—ã®å‡¦ç†ã«åˆ¶é™ãŒã‚ã‚‹
# 3. JSONã‚’tfvarsã«åŸ‹ã‚è¾¼ã‚€ã¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ãŒå¤šé‡ã«ãªã‚Šã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒå›°é›£
# 
# ç¾åœ¨ã®æ–¹å¼ã®åˆ©ç‚¹:
# - JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾ä¿å­˜ã—ã€Terraformã®file()é–¢æ•°ã§èª­ã¿è¾¼ã‚€ãŸã‚ã€ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ä¸è¦
# - .env.localã«ã¯1è¡Œã®JSONã‚’ä¿å­˜ã—ã€ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦æ‰±ã„ã‚„ã™ã„
# - google_service_account.jsonã¯.gitignoreã«è¿½åŠ æ¸ˆã¿ã§ã€èª¤ã£ãŸã‚³ãƒŸãƒƒãƒˆã‚’é˜²æ­¢
#
generate-tfvars: ## terraform.tfvarsã‚’.env.localã‹ã‚‰ç”Ÿæˆ
	@echo "ğŸ“ terraform.tfvarsã¨Googleèªè¨¼æƒ…å ±ã‚’ç”Ÿæˆä¸­..."
	@if [ -f .env.local ]; then \
		( \
			echo "# .env.localã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹Terraformå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«"; \
			echo "gemini_api_key=\"$$(grep GEMINI_API_KEY .env.local | cut -d '=' -f2-)\""; \
			echo "slack_bot_token=\"$$(grep SLACK_BOT_TOKEN .env.local | cut -d '=' -f2-)\""; \
			echo "slack_channel_id=\"$$(grep SLACK_CHANNEL_ID .env.local | cut -d '=' -f2-)\""; \
			echo "notion_api_key=\"$$(grep NOTION_API_KEY .env.local | cut -d '=' -f2-)\""; \
			echo "notion_database_id=\"$$(grep NOTION_DATABASE_ID .env.local | cut -d '=' -f2-)\""; \
			echo "notion_task_database_id=\"$$(grep NOTION_TASK_DATABASE_ID .env.local | cut -d '=' -f2-)\""; \
		) > infrastructure/environments/local/terraform.tfvars; \
		if [ -n "$$(grep GOOGLE_SERVICE_ACCOUNT_JSON .env.local | cut -d '=' -f2-)" ]; then \
			grep GOOGLE_SERVICE_ACCOUNT_JSON .env.local | cut -d '=' -f2- > infrastructure/environments/local/google_service_account.json; \
			if ! grep -q "google_service_account_json_path" infrastructure/environments/local/terraform.tfvars; then \
				echo "google_service_account_json_path=\"google_service_account.json\"" >> infrastructure/environments/local/terraform.tfvars; \
			fi; \
			echo "âœ… google_service_account.jsonã‚’ç”Ÿæˆã—ã¾ã—ãŸ"; \
		fi; \
		echo "âœ… terraform.tfvarsã‚’ç”Ÿæˆã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ .env.localãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚make setup ã‚’æœ€åˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
		exit 1; \
	fi

# LocalStackç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
setup-local: ## LocalStackç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
	@echo "ğŸš€ LocalStackç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
	@if [ ! -f .env.local ]; then \
		echo "âŒ .env.localãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚make setup ã‚’æœ€åˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
		exit 1; \
	fi
	@export $(cat .env.local | grep -v '^#' | xargs) && \
	docker compose -f $(DOCKER_COMPOSE_FILE) --profile dev up -d
	$(MAKE) wait-for-localstack
	@echo "âœ… LocalStackãŒèµ·å‹•ã—ã¾ã—ãŸ: $(LOCALSTACK_ENDPOINT)"

# LocalStackã®çŠ¶æ…‹ç¢ºèª
check-localstack: ## LocalStackã®çŠ¶æ…‹ã‚’ç¢ºèª
	@echo "ğŸ” LocalStackã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
	@curl -sf $(LOCALSTACK_ENDPOINT)/_localstack/health || (echo "âŒ LocalStackã«æ¥ç¶šã§ãã¾ã›ã‚“" && exit 1)

## LocalStackã®èµ·å‹•ã‚’å¾…æ©Ÿ
wait-for-localstack: ## LocalStackã®èµ·å‹•ã‚’å¾…æ©Ÿ
	@echo "â³ LocalStackã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
	@timeout=60; \
	while [ $$timeout -gt 0 ]; do \
		if curl -sf $(LOCALSTACK_ENDPOINT)/_localstack/health > /dev/null 2>&1; then \
			echo "âœ… LocalStackãŒèµ·å‹•ã—ã¾ã—ãŸ"; \
			exit 0; \
		fi; \
		printf "."; \
		sleep 3; \
		timeout=$$((timeout - 3)); \
	done; \
	echo "âŒ LocalStackã®èµ·å‹•ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"; \
	exit 1

build-lambda: ## Lambdaé–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰
	@echo "ğŸ”¨ Lambdaé–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	@mkdir -p infrastructure/modules/lambda
	@docker compose run --rm ruby-lambda-builder
	@echo "âœ… Lambdaé–¢æ•°ã®ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"

tf-init: ## Terraformã‚’åˆæœŸåŒ–
	@echo "TerraformåˆæœŸåŒ–ä¸­..."
	@if [ ! -f $(TF_DIR)/.terraform.lock.hcl ]; then \
		cd $(TF_DIR) && terraform init; \
	else \
		echo "Terraformã¯æ—¢ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã™"; \
	fi
	@echo "Terraformã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ"

# Terraformãƒ—ãƒ©ãƒ³ã®å®Ÿè¡Œ
tf-plan: tf-init ## Terraformãƒ—ãƒ©ãƒ³ã‚’å®Ÿè¡Œ
	@echo "ğŸ“‹ Terraformãƒ—ãƒ©ãƒ³ã‚’å®Ÿè¡Œä¸­..."
	@cd $(TF_DIR) && terraform plan
	@echo "âœ… Terraformãƒ—ãƒ©ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ"

# Terraformé©ç”¨ï¼ˆãƒ—ãƒ©ãƒ³ãªã—ï¼‰
tf-apply: ## Terraformã‚’é©ç”¨
	@echo "ğŸš€ Terraformã‚’é©ç”¨ä¸­..."
	@if [ -f $(TF_DIR)/terraform.tfvars ]; then \
		cd $(TF_DIR) && terraform apply -var-file="terraform.tfvars" -auto-approve; \
	else \
		cd $(TF_DIR) && terraform apply -auto-approve; \
	fi
	@echo "âœ… Terraformã®é©ç”¨ãŒå®Œäº†ã—ã¾ã—ãŸ"

# LocalStackç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ—ãƒ©ãƒ³ç¢ºèªã‚ã‚Šï¼‰
deploy-local: tf-plan tf-apply upload-prompts-local ## LocalStackç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
	@echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
	@echo "ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±:"
	@cd $(TF_DIR) && terraform output

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
upload-prompts-local: ## ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’LocalStackã®S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
	@echo "ğŸ“¤ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."
	@$(AWS_LOCAL_CREDENTIALS) ./scripts/upload_prompts_to_s3.sh local
	@echo "âœ… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"

# LocalStackç’°å¢ƒã‚’ç ´æ£„
destroy-local: ## LocalStackç’°å¢ƒã‚’ç ´æ£„
	@echo "ğŸ—‘ï¸  LocalStackç’°å¢ƒã‚’ç ´æ£„ä¸­..."
	@cd $(TF_DIR) && terraform destroy -auto-approve
	@echo "âœ… ç’°å¢ƒã®ç ´æ£„ãŒå®Œäº†ã—ã¾ã—ãŸ"

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
test: test-lambda

test-lambda:
	@echo "ğŸ§ª Lambdaé–¢æ•°ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	@docker compose run --rm --entrypoint="" ruby-lambda-builder sh -c "cd /var/task && bundle config unset without && bundle install --quiet && bundle exec rspec spec/ --format documentation"
	@echo "âœ… ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"

# ç°¡å˜ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
health-check: ## APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
	@echo "â¤ï¸  APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ä¸­..."
	@API_URL=$$(cd infrastructure/environments/local && terraform output -raw api_gateway_url); \
	curl -s "$$API_URL/health" -w "\nHTTP Status: %{http_code}\n" || echo "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"

# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean: ## ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
	@echo "ğŸ§¹ ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	@$(MAKE) clean-docker
	@$(MAKE) clean-build-artifacts
	@$(MAKE) clean-terraform
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

clean-docker:
	@echo "ğŸ³ Dockerç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	@docker compose -f docker-compose.yml down -v --rmi local
	@docker system prune -f

clean-build-artifacts:
	@echo "ğŸ—‚ï¸  ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤ä¸­..."
	@rm -f infrastructure/modules/lambda/lambda.zip
	@rm -f lambda/Gemfile.lock
	@rm -rf logs/ tmp/

clean-terraform:
	@echo "ğŸ—ï¸  TerraformçŠ¶æ…‹ã‚’å‰Šé™¤ä¸­..."
	@cd $(TF_DIR) && rm -rf .terraform .terraform.lock.hcl terraform.tfstate terraform.tfstate.backup terraform.tfvars google_service_account.json

clean-config:
	@echo "âš™ï¸  è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ä¸­..."
	@rm -f .env.local .env.production

# Lambdaé–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å®Œå…¨ãªã‚¿ã‚¹ã‚¯
build-and-deploy: build-lambda tf-init tf-apply upload-prompts-local ## Lambdaé–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤
	@echo "ğŸ‰ ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
	@echo "ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±:"
	@cd $(TF_DIR) && terraform output 2>/dev/null || echo "ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"

# é–‹ç™ºç’°å¢ƒã®å®Œå…¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
dev-setup: setup-local build-and-deploy ## é–‹ç™ºç’°å¢ƒã‚’å®Œå…¨ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
	@echo "ğŸ‰ é–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
	@echo ""
	@echo "ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªæƒ…å ±:"
	@cd $(TF_DIR) && \
	echo "API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: $$(terraform output -raw api_endpoint_url 2>/dev/null || echo 'N/A')" && \
	echo "API ã‚­ãƒ¼: $$(terraform output -raw api_key_value 2>/dev/null || echo 'N/A')"
	@echo ""
	@echo "ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
	@echo "â€¢ ç’°å¢ƒåœæ­¢: make stop"

# é–‹ç™ºç’°å¢ƒåœæ­¢
stop: ## é–‹ç™ºç’°å¢ƒã‚’åœæ­¢
	@echo "é–‹ç™ºç’°å¢ƒã‚’åœæ­¢ä¸­..."
	@if [ ! -f .env.local ]; then \
		echo "WARNING: .env.localãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚make setup ã‚’æœ€åˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"; \
		echo "Docker Composeã‚µãƒ¼ãƒ“ã‚¹ã‚’ç›´æ¥åœæ­¢ã—ã¾ã™..."; \
		docker compose -f $(DOCKER_COMPOSE_FILE) down 2>/dev/null || true; \
	else \
		export $$(cat .env.local | grep -v '^#' | xargs) && \
		docker compose -f $(DOCKER_COMPOSE_FILE) down; \
	fi
	@echo "é–‹ç™ºç’°å¢ƒãŒåœæ­¢ã—ã¾ã—ãŸ"

# æœ¬ç•ªç’°å¢ƒç”¨ã®terraform.tfvarsç”Ÿæˆ
generate-production-tfvars: ## .env.productionã‹ã‚‰terraform.tfvarsã‚’ç”Ÿæˆ
	@echo "ğŸ“ æœ¬ç•ªç’°å¢ƒç”¨terraform.tfvarsã‚’ç”Ÿæˆä¸­..."
	@if [ -f .env.production ]; then \
		( \
			echo "# .env.productionã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹Terraformå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«"; \
			echo "# åŸºæœ¬è¨­å®š"; \
			echo "aws_region = \"ap-northeast-1\""; \
			echo "environment = \"production\""; \
			echo "project_name = \"minutes-analyzer\""; \
			echo ""; \
			echo "# Lambdaè¨­å®š"; \
			echo "lambda_timeout = 900"; \
			echo "lambda_memory_size = 512"; \
			echo "log_retention_days = 30"; \
			echo "log_level = \"INFO\""; \
			echo "ai_model = \"gemini-2.5-flash\""; \
			echo ""; \
			echo "# API Keys (from .env.production)"; \
			echo "gemini_api_key=\"$$(grep GEMINI_API_KEY .env.production | cut -d '=' -f2-)\""; \
			echo "slack_bot_token=\"$$(grep SLACK_BOT_TOKEN .env.production | cut -d '=' -f2-)\""; \
			echo "slack_channel_id=\"$$(grep SLACK_CHANNEL_ID .env.production | cut -d '=' -f2-)\""; \
			echo "notion_api_key=\"$$(grep NOTION_API_KEY .env.production | cut -d '=' -f2-)\""; \
			echo "notion_database_id=\"$$(grep NOTION_DATABASE_ID .env.production | cut -d '=' -f2-)\""; \
			echo "notion_task_database_id=\"$$(grep NOTION_TASK_DATABASE_ID .env.production | cut -d '=' -f2-)\""; \
		) > infrastructure/environments/production/terraform.tfvars; \
		if [ -n "$$(grep GOOGLE_SERVICE_ACCOUNT_JSON .env.production | cut -d '=' -f2-)" ]; then \
			grep GOOGLE_SERVICE_ACCOUNT_JSON .env.production | cut -d '=' -f2- > infrastructure/environments/production/google_service_account.json; \
			if ! grep -q "google_service_account_json_path" infrastructure/environments/production/terraform.tfvars; then \
				echo "google_service_account_json_path=\"google_service_account.json\"" >> infrastructure/environments/production/terraform.tfvars; \
			fi; \
			echo "âœ… google_service_account.jsonã‚’ç”Ÿæˆã—ã¾ã—ãŸ"; \
		fi; \
		echo "âœ… terraform.tfvarsã‚’ç”Ÿæˆã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ .env.productionãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"; \
		echo "  cp .env.local .env.production ã§ã‚³ãƒ”ãƒ¼ã—ã¦ã€æœ¬ç•ªç”¨ã®å€¤ã«ç·¨é›†ã—ã¦ãã ã•ã„ã€‚"; \
		exit 1; \
	fi

ensure-terraform-backend-bucket: ## Terraform backendç”¨S3ãƒã‚±ãƒƒãƒˆã®å­˜åœ¨ç¢ºèªãƒ»ä½œæˆ
	@echo "ğŸª£ Terraform backendç”¨S3ãƒã‚±ãƒƒãƒˆã‚’ç¢ºèªä¸­..."
	@BUCKET_NAME="minutes-analyzer-terraform-state"; \
	if aws s3api head-bucket --bucket "$$BUCKET_NAME" --region ap-northeast-1 >/dev/null 2>&1; then \
		echo "âœ… S3ãƒã‚±ãƒƒãƒˆ '$$BUCKET_NAME' ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"; \
	else \
		echo "ğŸ”¨ S3ãƒã‚±ãƒƒãƒˆ '$$BUCKET_NAME' ã‚’ä½œæˆä¸­..."; \
		aws s3api create-bucket \
			--bucket "$$BUCKET_NAME" \
			--region ap-northeast-1 \
			--create-bucket-configuration LocationConstraint=ap-northeast-1; \
		echo "ğŸ” S3ãƒã‚±ãƒƒãƒˆã®æš—å·åŒ–ã‚’è¨­å®šä¸­..."; \
		aws s3api put-bucket-encryption \
			--bucket "$$BUCKET_NAME" \
			--server-side-encryption-configuration '{ \
				"Rules": [{ \
					"ApplyServerSideEncryptionByDefault": { \
						"SSEAlgorithm": "AES256" \
					}, \
					"BucketKeyEnabled": true \
				}] \
			}'; \
		echo "ğŸš« S3ãƒã‚±ãƒƒãƒˆã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ä¸­..."; \
		aws s3api put-public-access-block \
			--bucket "$$BUCKET_NAME" \
			--public-access-block-configuration \
				"BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"; \
		echo "âœ… S3ãƒã‚±ãƒƒãƒˆ '$$BUCKET_NAME' ã‚’ä½œæˆã—ã¾ã—ãŸ"; \
	fi

# AWSæœ¬ç•ªç’°å¢ƒç”¨ã®ã‚³ãƒãƒ³ãƒ‰
destroy-production: ## æœ¬ç•ªç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤
	@echo "ğŸ—‘ï¸  æœ¬ç•ªç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ä¸­..."
	@if [ ! -f .env.production ]; then \
		echo "âš ï¸  .env.productionãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚terraform.tfvarsãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"; \
	else \
		$(MAKE) generate-production-tfvars; \
	fi
	@echo "ğŸ—‘ï¸  Terraformã§ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ä¸­..."
	@cd infrastructure/environments/production && \
		terraform destroy -auto-approve 2>/dev/null || true
	@echo "ğŸ—‘ï¸  æ®‹å­˜ãƒªã‚½ãƒ¼ã‚¹ã‚’å¼·åˆ¶å‰Šé™¤ä¸­..."
	@echo "  - S3ãƒã‚±ãƒƒãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤..."
	@aws s3api list-object-versions --bucket minutes-analyzer-prompts-production --output json 2>/dev/null | \
		jq -r '.Versions[]?.Key, .DeleteMarkers[]?.Key' 2>/dev/null | \
		sort -u | \
		while read -r key; do \
			[ -z "$$key" ] && continue; \
			aws s3api list-object-versions --bucket minutes-analyzer-prompts-production --prefix "$$key" --output json 2>/dev/null | \
			jq -r '.Versions[]? | "--key \"" + .Key + "\" --version-id " + .VersionId' | \
			while read -r args; do \
				[ -z "$$args" ] && continue; \
				echo "    å‰Šé™¤ä¸­: $$key"; \
				eval "aws s3api delete-object --bucket minutes-analyzer-prompts-production $$args" 2>/dev/null || true; \
			done; \
			aws s3api list-object-versions --bucket minutes-analyzer-prompts-production --prefix "$$key" --output json 2>/dev/null | \
			jq -r '.DeleteMarkers[]? | "--key \"" + .Key + "\" --version-id " + .VersionId' | \
			while read -r args; do \
				[ -z "$$args" ] && continue; \
				eval "aws s3api delete-object --bucket minutes-analyzer-prompts-production $$args" 2>/dev/null || true; \
			done; \
		done || true
	@echo "  - S3ãƒã‚±ãƒƒãƒˆã®é€šå¸¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤..."
	@aws s3 rm s3://minutes-analyzer-prompts-production --recursive || true
	@echo "  - S3ãƒã‚±ãƒƒãƒˆæœ¬ä½“ã‚’å‰Šé™¤..."
	@aws s3 rb s3://minutes-analyzer-prompts-production --force || true
	@echo "  - Secrets Managerã‚’å‰Šé™¤..."
	@aws secretsmanager delete-secret --secret-id minutes-analyzer-secrets-production --force-delete-without-recovery 2>/dev/null || true
	@echo "  - Lambdaé–¢æ•°ã‚’å‰Šé™¤..."
	@aws lambda delete-function --function-name minutes-analyzer-production 2>/dev/null || true
	@echo "  - CloudWatch Logsã‚’å‰Šé™¤..."
	@aws logs delete-log-group --log-group-name /aws/lambda/minutes-analyzer-production 2>/dev/null || true
	@echo "ğŸ§¹ TerraformçŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	@cd infrastructure/environments/production && \
		rm -rf .terraform terraform.tfstate terraform.tfstate.backup .terraform.lock.hcl
	@echo "âœ… æœ¬ç•ªç’°å¢ƒãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸ"

clean-production: ## æœ¬ç•ªç’°å¢ƒã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
	@echo "ğŸ§¹ æœ¬ç•ªç’°å¢ƒã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	@cd infrastructure/environments/production && \
		rm -rf .terraform .terraform.lock.hcl terraform.tfstate terraform.tfstate.backup
	@rm -f infrastructure/environments/production/terraform.tfvars
	@rm -f infrastructure/environments/production/google_service_account.json
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

deploy-production: ## æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
	@echo "ğŸš€ æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	@if [ ! -f .env.production ]; then \
		echo "âŒ .env.productionãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"; \
		echo "  cp .env.local .env.production ã§ã‚³ãƒ”ãƒ¼ã—ã¦ã€æœ¬ç•ªç”¨ã®å€¤ã«ç·¨é›†ã—ã¦ãã ã•ã„ã€‚"; \
		exit 1; \
	fi
	@$(MAKE) generate-production-tfvars
	@$(MAKE) ensure-terraform-backend-bucket
	@cd infrastructure/environments/production && \
		terraform init && \
		terraform plan && \
		echo "âš ï¸  Review the plan above. Press Enter to continue or Ctrl+C to cancel..." && \
		read && \
		terraform apply
	@echo "ğŸ” Secrets Managerã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®šä¸­..."
	@./scripts/set-production-secrets.sh
	@echo "ğŸ“¤ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."
	@./scripts/upload_prompts_to_s3.sh production
	@echo "âœ… æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
	@echo "ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±:"
	@cd infrastructure/environments/production && terraform output
