# なぜ「自動検知」ではなく Slack Bot を採用したのか

## 背景
- Google Meet の文字起こしは、会議終了後に主催者の Drive「Meet Recordings」フォルダへ自動保存される。
- これを検知して AWS Lambda を実行したい、という要件が出発点。
- ただし「各ユーザーごとに設定が必要」な運用は避けたい。管理者側で一括管理したい。

## ゴール
- ユーザーの個別設定を最小化 or 不要化
- 誤検知・取りこぼしを減らし、運用負荷も抑える
- セキュリティ・監査要件を満たしつつ、短期間でデリバリー

## 検討したアプローチ
1. ドメイン一括の「自動検知」（監査ログ → Cloud Logging → Pub/Sub → Lambda）
   - 管理者が Workspace 監査ログを GCP に連携し、ログシンクでイベント駆動
   - 必要に応じて Drive API で詳細確認
   - 前提: エディション要件や GCP 側の整備が必要

2. Admin SDK Reports API をポーリング
   - 管理者権限でドメイン全体の Drive/Meet イベントを定期取得
   - ただしリアルタイム性とクォータ、重複排除の実装コストが課題

3. Drive API Push 通知（全ユーザー監視）
   - 各ユーザーの Drive changes.watch を張る
   - チャンネルの有効期限・更新・スケール・エラー復旧など運用コストが高い
   - 実質「個人ごとに設定（＝監視）を維持」することになる

4. Slack Bot による「手動選択トリガ」
   - Slack のモーダルで Drive ファイルを検索・選択し、Lambda を起動
   - Google 連携は「ユーザーOAuth」か「ドメイン全体委任（DWD）」で実現
   - ユーザーが意図したタイミングだけ処理され、誤検知を抑制

## 比較の観点
- 導入コスト（初期設定・インフラ）
- 運用コスト（更新・監視・復旧）
- ユーザーごとの設定の有無
- リアルタイム性
- セキュリティ/監査（権限、証跡、誤作動リスク）
- タイムトゥマーケット

| アプローチ | 初期/運用コスト | ユーザー個別設定 | リアルタイム性 | セキュリティ/監査 | 備考 |
|---|---|---|---|---|---|
| 監査ログ→Pub/Sub→Lambda | 中〜高 | 不要 | 高 | 良（監査ログ起点） | エディション/GCP整備が前提。クロスクラウド連携の設計が必要 |
| Reports API ポーリング | 中 | 不要 | 中〜低 | 可（設計次第） | 重複排除・リトライ・クォータ管理が難点 |
| Drive Push（全ユーザー） | 高 | 事実上必要 | 高 | 運用起因のリスク | チャンネル更新・スケール運用が重い |
| Slack Bot（手動選択） | 低〜中 | 最小（DWDなら不要） | 中（ユーザー操作依存） | 良（明示操作・権限最小化） | 短納期で開始しやすく、誤処理を抑制 |

## 最終判断
- Google Workspace 側での「完全自動・一括管理」は運用/設定コストが高く、導入までの調整も大きい。
  - 監査ログ連携は強力だが、エディション要件や GCP プロジェクト整備、ログ設計・セキュリティ審査が必要。
  - Drive Push 通知はユーザー単位の監視維持が不可避で、スケールするほど運用が重い（個人ごと設定の問題に近い）。
- 短期で価値を出すには、ユーザー主導で確実に処理できる Slack Bot が最適。
  - 明示的な「選択→実行」で誤検知を防げる。
  - 連携方式は2択:
    - ユーザーOAuth: 各自一回同意（最低限の「個人設定」）。権限はそのユーザーの可視範囲に限定。
    - DWD: 管理者が一括設定し、ユーザーの同意不要（内部統制が整っていれば最小のユーザー負担）。

## 採用アーキテクチャ（概要）
- Slack: スラッシュコマンド/ショートカット → モーダル検索（external_select）
- Google Drive: ユーザーOAuth または DWD で検索・取得
- AWS: API Gateway 経由で Lambda 起動（fileId などを引き渡し）
- 返却: Slack のスレッド/DMで進捗・結果通知
- セキュリティ: 最小権限、署名検証、監査ログ、冪等処理

## リスクと対応
- 手動ゆえの「やり忘れ」リスク → リマインダー/定期スラッシュコマンド/ワークフロービルダー連携
- 検索候補が多すぎる → 「Meet Recordings」配下＋日付/会議名で絞り込み
- エクスポート整合遅延 → リトライ/バックオフ実装

## 意思決定フロー（テキスト図）
- 自動検知でいく？
  - 監査ログ基盤を短期で整備できるか → No
    - Push 通知を全ユーザー分運用できるか → No（コスト高/更新運用）
      - 手動トリガ許容か → Yes → Slack Bot 採用
    - → Yes なら「監査ログ→Pub/Sub→Lambda」も選択肢
  - → Yes なら自動検知を検討、ただし運用・セキュリティ審査をクリアすること

## まとめ:
「Google Workspaceでの一括管理は強力だが初期・運用コストが高い」<br>
「個人ごとの設定維持も重い」

そこで、まずは Slack Bot による明示的なファイル選択で Lambda を起動し、短期間で価値を提供しつつ、将来的に自動化へ段階的に拡張できる道を選んだ。
