MAKEFLAGS += --silent
.PHONY: help setup build clean test deploy tf-plan tf-apply destroy

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help: ## ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ç’°å¢ƒå¤‰æ•°
AWS_REGION ?= ap-northeast-1
PROJECT_NAME = drive-selector
ENVIRONMENT = production
BUILD_DIR = build
LAMBDA_DIR = lambda
OUTPUT_FILE = lambda.zip
TF_DIR = infrastructure

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
setup: ## åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
	@echo "ğŸ“‹ Slack Bot Drive Selector åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
	@if [ -f .env.local ]; then \
		echo "ğŸ“‹ .env.localã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"; \
	else \
		echo "âš ï¸  .env.localãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„"; \
		echo "    è©³ç´°ã¯ README.md ã‚’å‚ç…§ã—ã¦ãã ã•ã„"; \
	fi
	@echo "ğŸ“¦ Rubyä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
	@if command -v bundle >/dev/null 2>&1; then \
		cd $(LAMBDA_DIR) && bundle install; \
	else \
		echo "âš ï¸  BundlerãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Rubyã®ä¾å­˜é–¢ä¿‚ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"; \
	fi
	@echo "âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

# Lambdaé–¢æ•°ã®ãƒ“ãƒ«ãƒ‰ï¼ˆå…±é€šï¼‰
build: ## Lambdaé–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
	@echo "ğŸ”¨ Lambdaé–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	@mkdir -p infrastructure/modules/lambda
	@docker compose run --rm ruby-lambda-builder
	@if [ -f infrastructure/modules/lambda/lambda.zip ]; then \
		cp infrastructure/modules/lambda/lambda.zip $(OUTPUT_FILE); \
		echo "âœ… Lambdaé–¢æ•°ã®ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"; \
		echo "ğŸ“Š Package size: $$(du -h $(OUTPUT_FILE) | cut -f1)"; \
		SIZE_IN_MB=$$(du -m $(OUTPUT_FILE) | cut -f1); \
		if [ $$SIZE_IN_MB -gt 50 ]; then \
			echo "âš ï¸  Warning: Package size exceeds 50MB. Consider using Lambda Layers for dependencies."; \
		fi; \
	else \
		echo "âŒ ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"; \
		exit 1; \
	fi

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
test: ## ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
	@echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	@cd $(LAMBDA_DIR) && \
		bundle config set --local path 'vendor/bundle' && \
		bundle install --quiet && \
		bundle exec rspec spec/ --format documentation
	@echo "âœ… ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"

# Terraformã®åˆæœŸåŒ–
tf-init: ## Terraformã‚’åˆæœŸåŒ–
	@echo "ğŸ—ï¸  TerraformåˆæœŸåŒ–ä¸­..."
	@if [ ! -f $(TF_DIR)/.terraform.lock.hcl ]; then \
		cd $(TF_DIR) && terraform init; \
	else \
		echo "Terraformã¯æ—¢ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã™"; \
	fi
	@echo "âœ… Terraformã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ"

# Terraformãƒ—ãƒ©ãƒ³ã®å®Ÿè¡Œ
tf-plan: tf-init ## Terraformãƒ—ãƒ©ãƒ³ã‚’å®Ÿè¡Œ
	@echo "ğŸ“‹ Terraformãƒ—ãƒ©ãƒ³ã‚’å®Ÿè¡Œä¸­..."
	@if [ ! -f $(TF_DIR)/terraform.production.tfvars ]; then \
		echo "âŒ terraform.production.tfvarsãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		echo "  infrastructure/terraform.production.tfvars ã‚’ä½œæˆã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi
	@cd $(TF_DIR) && terraform plan -var-file=terraform.production.tfvars
	@echo "âœ… Terraformãƒ—ãƒ©ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ"

# Terraformé©ç”¨
tf-apply: tf-init ## Terraformã‚’é©ç”¨
	@echo "ğŸš€ Terraformã‚’é©ç”¨ä¸­..."
	@if [ ! -f $(TF_DIR)/terraform.production.tfvars ]; then \
		echo "âŒ terraform.production.tfvarsãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		echo "  infrastructure/terraform.production.tfvars ã‚’ä½œæˆã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi
	@cd $(TF_DIR) && terraform apply -var-file=terraform.production.tfvars
	@echo "âœ… Terraformã®é©ç”¨ãŒå®Œäº†ã—ã¾ã—ãŸ"

# ãƒ‡ãƒ—ãƒ­ã‚¤
deploy: build ## æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
	@echo "ğŸš€ æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	@if [ ! -f $(TF_DIR)/terraform.production.tfvars ]; then \
		echo "âŒ terraform.production.tfvarsãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		echo "  infrastructure/terraform.production.tfvars ã‚’ä½œæˆã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi
	@$(MAKE) tf-plan
	@echo "âš ï¸  ä¸Šè¨˜ã®ãƒ—ãƒ©ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚Enterã‚­ãƒ¼ã§ç¶šè¡Œã€Ctrl+Cã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«..."
	@read
	@$(MAKE) tf-apply
	@echo "âœ… æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
	@echo "ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±:"
	@cd $(TF_DIR) && terraform output

# ç’°å¢ƒç ´æ£„
destroy: ## æœ¬ç•ªç’°å¢ƒã‚’ç ´æ£„ï¼ˆè¦ç¢ºèªï¼‰
	@echo "âš ï¸  æœ¬ç•ªç’°å¢ƒã‚’ç ´æ£„ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ï¼"
	@echo "æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ 'yes' ã¨å…¥åŠ›ã—ã¦ãã ã•ã„:"
	@read confirm && [ "$$confirm" = "yes" ] || (echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ" && exit 1)
	@echo "ğŸ—‘ï¸  æœ¬ç•ªç’°å¢ƒã‚’ç ´æ£„ä¸­..."
	@cd $(TF_DIR) && terraform destroy -var-file=terraform.production.tfvars -auto-approve
	@echo "âœ… æœ¬ç•ªç’°å¢ƒã®ç ´æ£„ãŒå®Œäº†ã—ã¾ã—ãŸ"

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean: clean-build clean-terraform ## å…¨ã¦ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

clean-build: ## ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
	@echo "ğŸ§¹ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	@rm -rf $(BUILD_DIR)
	@rm -f $(OUTPUT_FILE)
	@rm -f $(LAMBDA_DIR)/Gemfile.lock
	@cd $(LAMBDA_DIR) && rm -rf vendor/ .bundle/

clean-terraform: ## TerraformçŠ¶æ…‹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
	@echo "ğŸ—ï¸  TerraformçŠ¶æ…‹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	@cd $(TF_DIR) && rm -rf .terraform .terraform.lock.hcl terraform.tfstate terraform.tfstate.backup

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆæœ¬ç•ªãƒ»é–‹ç™ºç’°å¢ƒå¯¾å¿œï¼‰
health-check: ## APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
	@echo "â¤ï¸  APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ä¸­..."
	@if [ -f $(TF_DIR)/terraform.tfstate ]; then \
		API_URL=$$(cd $(TF_DIR) && terraform output -raw api_gateway_url 2>/dev/null); \
		if [ -n "$$API_URL" ]; then \
			curl -s "$$API_URL/health" -w "\nHTTP Status: %{http_code}\n" || echo "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"; \
		else \
			echo "API URLãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"; \
		fi; \
	else \
		echo "ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãš 'make deploy-local' ã¾ãŸã¯ 'make deploy-production' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	fi

# ãƒ­ã‚°ç¢ºèª
logs: ## Lambdaé–¢æ•°ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	@echo "ğŸ“œ Lambdaé–¢æ•°ã®ãƒ­ã‚°ã‚’ç¢ºèªä¸­..."
	@aws logs describe-log-groups --log-group-name-prefix "/aws/lambda/$(PROJECT_NAME)" --query 'logGroups[0].logGroupName' --output text | \
	xargs -I {} aws logs tail {} --follow

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨ï¼‰
dev-server: ## é–‹ç™ºç”¨ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨ï¼‰
	@echo "ğŸš€ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­..."
	@cd $(LAMBDA_DIR) && \
		bundle install && \
		ruby -r './handler.rb' -e "puts 'Development server ready. Use for local testing.'"