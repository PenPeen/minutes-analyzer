MAKEFLAGS += --silent
.PHONY: help setup build clean test deploy-package deploy-local deploy-production

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help: ## ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ç’°å¢ƒå¤‰æ•°
AWS_REGION ?= ap-northeast-1
PROJECT_NAME = slack-bot-drive-selector
ENVIRONMENT ?= development
BUILD_DIR = build
LAMBDA_DIR = lambda
OUTPUT_FILE = lambda.zip
TF_DIR = infrastructure

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
setup: ## åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
	@echo "ğŸ“‹ Slack Bot Drive Selector åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
	@if [ -f .env.local ]; then \
		echo "ğŸ“‹ .env.localã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"; \
	else \
		echo "âš ï¸  .env.localãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„"; \
		echo "    è©³ç´°ã¯ README.md ã‚’å‚ç…§ã—ã¦ãã ã•ã„"; \
	fi
	@echo "ğŸ“¦ Rubyä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
	@if command -v bundle >/dev/null 2>&1; then \
		cd $(LAMBDA_DIR) && bundle install; \
	else \
		echo "âš ï¸  BundlerãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Rubyã®ä¾å­˜é–¢ä¿‚ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"; \
	fi
	@echo "âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

# Lambdaé–¢æ•°ã®ãƒ“ãƒ«ãƒ‰
build: ## Lambdaé–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
	@echo "ğŸš€ Lambdaé–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	@$(MAKE) clean-build
	@echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆä¸­..."
	@mkdir -p $(BUILD_DIR)
	@echo "ğŸ“ Lambdaé–¢æ•°ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ä¸­..."
	@cp -r $(LAMBDA_DIR)/* $(BUILD_DIR)/
	@echo "ğŸ“¦ Rubyä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­ï¼ˆLambdaäº’æ›ç’°å¢ƒï¼‰..."
	@if [ -f "$(BUILD_DIR)/Gemfile" ]; then \
		docker run --rm \
			-v "$(PWD)/$(BUILD_DIR)":/var/task \
			-w /var/task \
			public.ecr.aws/lambda/ruby:3.2 \
			bash -c "bundle config set --local path 'vendor/bundle' && \
			         bundle config set --local without 'development test' && \
			         bundle install && \
			         rm -rf vendor/bundle/ruby/*/cache"; \
	fi
	@echo "ğŸ“¦ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆä¸­..."
	@cd $(BUILD_DIR) && zip -r ../$(OUTPUT_FILE) . -x "*.git*" "spec/*" "*.md" "Gemfile.lock"
	@$(MAKE) clean-build
	@echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†! Output: $(OUTPUT_FILE)"
	@echo "ğŸ“Š Package size: $$(du -h $(OUTPUT_FILE) | cut -f1)"
	@SIZE_IN_MB=$$(du -m $(OUTPUT_FILE) | cut -f1); \
	if [ $$SIZE_IN_MB -gt 50 ]; then \
		echo "âš ï¸  Warning: Package size exceeds 50MB. Consider using Lambda Layers for dependencies."; \
	fi

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
test: ## ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
	@echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	@cd $(LAMBDA_DIR) && \
		bundle config set --local path 'vendor/bundle' && \
		bundle install --quiet && \
		bundle exec rspec spec/ --format documentation
	@echo "âœ… ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"

# Terraformã®åˆæœŸåŒ–
tf-init: ## Terraformã‚’åˆæœŸåŒ–
	@echo "ğŸ—ï¸  TerraformåˆæœŸåŒ–ä¸­..."
	@if [ ! -f $(TF_DIR)/.terraform.lock.hcl ]; then \
		cd $(TF_DIR) && terraform init; \
	else \
		echo "Terraformã¯æ—¢ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã™"; \
	fi
	@echo "âœ… Terraformã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ"

# Terraformãƒ—ãƒ©ãƒ³ã®å®Ÿè¡Œ
tf-plan: tf-init ## Terraformãƒ—ãƒ©ãƒ³ã‚’å®Ÿè¡Œ
	@echo "ğŸ“‹ Terraformãƒ—ãƒ©ãƒ³ã‚’å®Ÿè¡Œä¸­..."
	@cd $(TF_DIR) && terraform plan
	@echo "âœ… Terraformãƒ—ãƒ©ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ"

# Terraformé©ç”¨
tf-apply: tf-init ## Terraformã‚’é©ç”¨
	@echo "ğŸš€ Terraformã‚’é©ç”¨ä¸­..."
	@cd $(TF_DIR) && terraform apply -auto-approve
	@echo "âœ… Terraformã®é©ç”¨ãŒå®Œäº†ã—ã¾ã—ãŸ"

# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
deploy-local: build tf-apply ## ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒï¼ˆLocalStackï¼‰ã«ãƒ‡ãƒ—ãƒ­ã‚¤
	@echo "ğŸš€ ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	@echo "âœ… ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
	@echo "ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±:"
	@cd $(TF_DIR) && terraform output 2>/dev/null || echo "ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"

# æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
deploy-production: ## æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
	@echo "ğŸš€ æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	@if [ ! -f .env.production ]; then \
		echo "âŒ .env.productionãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		echo "  æœ¬ç•ªç’°å¢ƒç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi
	@$(MAKE) build
	@ENVIRONMENT=production $(MAKE) tf-apply
	@echo "âœ… æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
	@echo "ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±:"
	@ENVIRONMENT=production cd $(TF_DIR) && terraform output

# ç’°å¢ƒç ´æ£„
destroy: ## ç’°å¢ƒã‚’ç ´æ£„
	@echo "ğŸ—‘ï¸  ç’°å¢ƒã‚’ç ´æ£„ä¸­..."
	@cd $(TF_DIR) && terraform destroy -auto-approve
	@echo "âœ… ç’°å¢ƒã®ç ´æ£„ãŒå®Œäº†ã—ã¾ã—ãŸ"

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean: clean-build clean-terraform ## å…¨ã¦ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

clean-build: ## ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
	@echo "ğŸ§¹ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	@rm -rf $(BUILD_DIR)
	@rm -f $(OUTPUT_FILE)
	@rm -f $(LAMBDA_DIR)/Gemfile.lock
	@cd $(LAMBDA_DIR) && rm -rf vendor/ .bundle/

clean-terraform: ## TerraformçŠ¶æ…‹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
	@echo "ğŸ—ï¸  TerraformçŠ¶æ…‹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	@cd $(TF_DIR) && rm -rf .terraform .terraform.lock.hcl terraform.tfstate terraform.tfstate.backup

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆæœ¬ç•ªãƒ»é–‹ç™ºç’°å¢ƒå¯¾å¿œï¼‰
health-check: ## APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
	@echo "â¤ï¸  APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ä¸­..."
	@if [ -f $(TF_DIR)/terraform.tfstate ]; then \
		API_URL=$$(cd $(TF_DIR) && terraform output -raw api_gateway_url 2>/dev/null); \
		if [ -n "$$API_URL" ]; then \
			curl -s "$$API_URL/health" -w "\nHTTP Status: %{http_code}\n" || echo "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"; \
		else \
			echo "API URLãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"; \
		fi; \
	else \
		echo "ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãš 'make deploy-local' ã¾ãŸã¯ 'make deploy-production' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	fi

# ãƒ­ã‚°ç¢ºèª
logs: ## Lambdaé–¢æ•°ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	@echo "ğŸ“œ Lambdaé–¢æ•°ã®ãƒ­ã‚°ã‚’ç¢ºèªä¸­..."
	@aws logs describe-log-groups --log-group-name-prefix "/aws/lambda/$(PROJECT_NAME)" --query 'logGroups[0].logGroupName' --output text | \
	xargs -I {} aws logs tail {} --follow

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨ï¼‰
dev-server: ## é–‹ç™ºç”¨ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨ï¼‰
	@echo "ğŸš€ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­..."
	@cd $(LAMBDA_DIR) && \
		bundle install && \
		ruby -r './handler.rb' -e "puts 'Development server ready. Use for local testing.'"