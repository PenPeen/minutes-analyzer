MAKEFLAGS += --silent
.PHONY: help setup build clean test deploy-production destroy-production clean-production build-lambda tf-init tf-plan tf-apply generate-production-tfvars ensure-terraform-backend-bucket health-check logs check-resources terraform-fmt-production terraform-validate-production

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help: ## ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ç’°å¢ƒå¤‰æ•°
AWS_REGION = ap-northeast-1
PROJECT_NAME = drive-selector
ENVIRONMENT = production
TF_DIR = infrastructure/environments/production

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
setup: ## åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
	@echo "ğŸ“‹ Drive Selector åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
	@if [ -f .env.production ]; then \
		echo "ğŸ“‹ .env.productionã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ï¼ˆä¿è­·ã•ã‚Œã¦ã„ã¾ã™ï¼‰"; \
		echo "ğŸ”§ ãã®ä»–ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ç¶™ç¶šã—ã¾ã™..."; \
	else \
		echo "âš ï¸  .env.productionãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„"; \
		echo "    è©³ç´°ã¯ README.md ã‚’å‚ç…§ã—ã¦ãã ã•ã„"; \
	fi
	@echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
	@if command -v bundle >/dev/null 2>&1; then \
		cd lambda && bundle install; \
	else \
		echo "âš ï¸  BundlerãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Rubyã®ä¾å­˜é–¢ä¿‚ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"; \
	fi
	@echo "âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

# æœ¬ç•ªç’°å¢ƒç”¨ãƒ“ãƒ«ãƒ‰
build-production: ## æœ¬ç•ªç’°å¢ƒç”¨Lambdaé–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰
	@echo "ğŸ”¨ æœ¬ç•ªç’°å¢ƒç”¨Lambdaé–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	@mkdir -p infrastructure/modules/lambda
	@docker compose run --rm ruby-lambda-builder
	@echo "âœ… æœ¬ç•ªç’°å¢ƒç”¨ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"

build-lambda: ## Lambdaé–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰ã€€ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
	@echo "ğŸ”¨ Lambdaé–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	@mkdir -p infrastructure/modules/lambda
	@docker compose run --rm ruby-lambda-builder
	@echo "âœ… Lambdaé–¢æ•°ã®ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"


test: ## ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
	@echo "ğŸ§ª Lambdaé–¢æ•°ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	@docker compose run --rm --entrypoint="" ruby-lambda-builder sh -c "cd /var/task && bundle config unset without && bundle install --quiet && bundle exec rspec spec/ --format documentation"
	@echo "âœ… ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"

# æœ¬ç•ªç’°å¢ƒç”¨TerraformåˆæœŸåŒ–
tf-init-production: ensure-terraform-backend-bucket-production ## æœ¬ç•ªç’°å¢ƒç”¨Terraformã‚’åˆæœŸåŒ–
	@echo "æœ¬ç•ªç’°å¢ƒç”¨TerraformåˆæœŸåŒ–ä¸­..."
	@if [ ! -f $(TF_DIR)/.terraform.lock.hcl ]; then \
		cd $(TF_DIR) && terraform init; \
	else \
		echo "æœ¬ç•ªç’°å¢ƒç”¨Terraformã¯æ—¢ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã™"; \
	fi
	@echo "æœ¬ç•ªç’°å¢ƒç”¨Terraformã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ"

# æœ¬ç•ªç’°å¢ƒç”¨Terraformãƒ—ãƒ©ãƒ³
tf-plan-production: tf-init-production generate-tfvars-production build-production ## æœ¬ç•ªç’°å¢ƒç”¨Terraformãƒ—ãƒ©ãƒ³ã‚’å®Ÿè¡Œ
	@echo "ğŸ“‹ æœ¬ç•ªç’°å¢ƒç”¨Terraformãƒ—ãƒ©ãƒ³ã‚’å®Ÿè¡Œä¸­..."
	@if [ -f $(TF_DIR)/terraform.tfvars ]; then \
		cd $(TF_DIR) && terraform plan -var-file="terraform.tfvars"; \
	else \
		cd $(TF_DIR) && terraform plan; \
	fi
	@echo "âœ… æœ¬ç•ªç’°å¢ƒç”¨Terraformãƒ—ãƒ©ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ"

# æœ¬ç•ªç’°å¢ƒç”¨Terraformé©ç”¨
tf-apply-production: ## æœ¬ç•ªç’°å¢ƒç”¨Terraformã‚’é©ç”¨
	@echo "ğŸš€ æœ¬ç•ªç’°å¢ƒç”¨Terraformã‚’é©ç”¨ä¸­..."
	@if [ -f $(TF_DIR)/terraform.tfvars ]; then \
		cd $(TF_DIR) && terraform apply -var-file="terraform.tfvars" -auto-approve; \
	else \
		cd $(TF_DIR) && terraform apply -auto-approve; \
	fi
	@echo "âœ… æœ¬ç•ªç’°å¢ƒç”¨Terraformã®é©ç”¨ãŒå®Œäº†ã—ã¾ã—ãŸ"

deploy-production: ## æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
	@echo "ğŸš€ æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	@echo "âš ï¸  æ³¨æ„: æ‰‹å‹•ã§AWSãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ãªã„ã§ãã ã•ã„ã€‚ã™ã¹ã¦Terraformã§ç®¡ç†ã•ã‚Œã¾ã™ã€‚"
	@if [ ! -f .env.production ]; then \
		echo "âŒ .env.productionãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"; \
		echo "  æœ¬ç•ªç’°å¢ƒç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚"; \
		exit 1; \
	fi
	@$(MAKE) generate-tfvars-production
	@$(MAKE) ensure-terraform-backend-bucket-production
	@$(MAKE) build-production
	@cd $(TF_DIR) && \
		terraform init && \
		terraform plan -var-file="terraform.tfvars" && \
		echo "âš ï¸  Review the plan above. Press Enter to continue or Ctrl+C to cancel..." && \
		read && \
		terraform apply -var-file="terraform.tfvars"
	@echo "ğŸ” Secrets Managerã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®šä¸­..."
	@./scripts/set-production-secrets.sh
	@echo "âœ… æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
	@echo "ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±:"
	@cd $(TF_DIR) && terraform output

# æœ¬ç•ªç’°å¢ƒç”¨ã®terraform.tfvarsç”Ÿæˆ
generate-tfvars-production: ## æœ¬ç•ªç’°å¢ƒç”¨terraform.tfvarsã‚’.env.productionã‹ã‚‰ç”Ÿæˆ
	@echo "ğŸ“ æœ¬ç•ªç’°å¢ƒç”¨terraform.tfvarsã‚’ç”Ÿæˆä¸­..."
	@if [ -f .env.production ]; then \
		( \
			echo "# .env.productionã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹Terraformå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«"; \
			echo "# åŸºæœ¬è¨­å®š"; \
			echo "aws_region = \"ap-northeast-1\""; \
			echo "environment = \"production\""; \
			echo "project_name = \"drive-selector\""; \
			echo ""; \
			echo "# Lambdaè¨­å®š"; \
			echo "lambda_timeout = 30"; \
			echo "lambda_memory_size = 256"; \
			echo ""; \
			echo "# Slackè¨­å®š (from .env.production)"; \
			echo "slack_signing_secret=\"$$(grep SLACK_SIGNING_SECRET .env.production | cut -d '=' -f2-)\""; \
			echo "slack_bot_token=\"$$(grep SLACK_BOT_TOKEN .env.production | cut -d '=' -f2-)\""; \
			echo "slack_channel_id=\"$$(grep SLACK_CHANNEL_ID .env.production | cut -d '=' -f2-)\""; \
			echo ""; \
			echo "# Google OAuthè¨­å®š (from .env.production)"; \
			echo "google_client_id=\"$$(grep GOOGLE_CLIENT_ID .env.production | cut -d '=' -f2-)\""; \
			echo "google_client_secret=\"$$(grep GOOGLE_CLIENT_SECRET .env.production | cut -d '=' -f2-)\""; \
			echo ""; \
			echo "# Lambda ARNè¨­å®š"; \
			echo "process_lambda_arn=\"$$(grep PROCESS_LAMBDA_ARN .env.production | cut -d '=' -f2-)\""; \
		) > $(TF_DIR)/terraform.tfvars; \
		echo "âœ… terraform.tfvarsã‚’ç”Ÿæˆã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ .env.productionãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"; \
		exit 1; \
	fi

ensure-terraform-backend-bucket-production: ## æœ¬ç•ªç’°å¢ƒç”¨Terraform backend S3ãƒã‚±ãƒƒãƒˆã®å­˜åœ¨ç¢ºèªãƒ»ä½œæˆ
	@echo "ğŸª£ Terraform backendç”¨S3ãƒã‚±ãƒƒãƒˆã‚’ç¢ºèªä¸­..."
	@BUCKET_NAME="drive-selector-terraform-state"; \
	if aws s3api head-bucket --bucket "$$BUCKET_NAME" --region ap-northeast-1 >/dev/null 2>&1; then \
		echo "âœ… S3ãƒã‚±ãƒƒãƒˆ '$$BUCKET_NAME' ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"; \
	else \
		echo "ğŸ”¨ S3ãƒã‚±ãƒƒãƒˆ '$$BUCKET_NAME' ã‚’ä½œæˆä¸­..."; \
		aws s3api create-bucket \
			--bucket "$$BUCKET_NAME" \
			--region ap-northeast-1 \
			--create-bucket-configuration LocationConstraint=ap-northeast-1; \
		echo "ğŸ” S3ãƒã‚±ãƒƒãƒˆã®æš—å·åŒ–ã‚’è¨­å®šä¸­..."; \
		aws s3api put-bucket-encryption \
			--bucket "$$BUCKET_NAME" \
			--server-side-encryption-configuration '{ \
				"Rules": [{ \
					"ApplyServerSideEncryptionByDefault": { \
						"SSEAlgorithm": "AES256" \
					}, \
					"BucketKeyEnabled": true \
				}] \
			}'; \
		echo "ğŸš« S3ãƒã‚±ãƒƒãƒˆã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ä¸­..."; \
		aws s3api put-public-access-block \
			--bucket "$$BUCKET_NAME" \
			--public-access-block-configuration \
				"BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"; \
		echo "âœ… S3ãƒã‚±ãƒƒãƒˆ '$$BUCKET_NAME' ã‚’ä½œæˆã—ã¾ã—ãŸ"; \
	fi

destroy-production: ## æœ¬ç•ªç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤
	@echo "ğŸ—‘ï¸  æœ¬ç•ªç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ä¸­..."
	@if [ ! -f .env.production ]; then \
		echo "âš ï¸  .env.productionãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚terraform.tfvarsãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"; \
	else \
		$(MAKE) generate-tfvars-production; \
	fi
	@echo "ğŸ—‘ï¸  Terraformã§ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ä¸­..."
	@cd $(TF_DIR) && \
		terraform destroy -auto-approve 2>/dev/null || true
	@echo "âœ… æœ¬ç•ªç’°å¢ƒãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ"

clean-production: ## æœ¬ç•ªç’°å¢ƒã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
	@echo "ğŸ§¹ æœ¬ç•ªç’°å¢ƒã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	@cd $(TF_DIR) && \
		rm -rf .terraform .terraform.lock.hcl terraform.tfstate terraform.tfstate.backup
	@rm -f $(TF_DIR)/terraform.tfvars
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean: ## ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
	@echo "ğŸ§¹ ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	@$(MAKE) clean-build-artifacts
	@$(MAKE) clean-terraform
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

clean-build-artifacts:
	@echo "ğŸ—‚ï¸  ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤ä¸­..."
	@rm -f infrastructure/modules/lambda/lambda.zip
	@rm -f lambda/Gemfile.lock
	@rm -rf logs/ tmp/

clean-terraform:
	@echo "ğŸ—ï¸  TerraformçŠ¶æ…‹ã‚’å‰Šé™¤ä¸­..."
	@cd $(TF_DIR) && rm -rf .terraform .terraform.lock.hcl terraform.tfstate terraform.tfstate.backup terraform.tfvars

# ç°¡å˜ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
health-check: ## APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
	@echo "â¤ï¸  APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ä¸­..."
	@API_URL=$$(cd $(TF_DIR) && terraform output -raw api_gateway_url 2>/dev/null); \
	if [ -n "$$API_URL" ]; then \
		curl -s "$$API_URL/health" -w "\nHTTP Status: %{http_code}\n" || echo "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"; \
	else \
		echo "API URLãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"; \
	fi

# ãƒ­ã‚°ç¢ºèª
logs: ## Lambdaé–¢æ•°ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	@echo "ğŸ“œ Lambdaé–¢æ•°ã®ãƒ­ã‚°ã‚’ç¢ºèªä¸­..."
	@aws logs describe-log-groups --log-group-name-prefix "/aws/lambda/$(PROJECT_NAME)" --query 'logGroups[0].logGroupName' --output text | \
	xargs -I {} aws logs tail {} --follow

# ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèª
check-resources: ## AWSãƒªã‚½ãƒ¼ã‚¹ã¨TerraformçŠ¶æ…‹ã®æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯
	@echo "ğŸ” ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
	@echo "ğŸ“‹ ç¾åœ¨ã®API Gatewayä¸€è¦§:"
	@aws apigateway get-rest-apis --query 'items[].[id,name,endpointConfiguration.types[0]]' --output table
	@echo ""
	@echo "ğŸ“‹ Terraformç®¡ç†ä¸‹ã®ãƒªã‚½ãƒ¼ã‚¹:"
	@cd $(TF_DIR) && terraform state list | grep -E "(api_gateway|lambda)" || echo "TerraformçŠ¶æ…‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
	@echo ""
	@echo "âš ï¸  æ‰‹å‹•ã§ä½œæˆã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ãŒã‚ã‚‹å ´åˆã¯ã€Terraformã§importã™ã‚‹ã‹å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚"

# terraformæ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ï¼ˆæœ¬ç•ªç’°å¢ƒç”¨ï¼‰
terraform-fmt-production: ## æœ¬ç•ªç’°å¢ƒã®Terraformãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
	@echo "ğŸ”§ æœ¬ç•ªç’°å¢ƒã®Terraformãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸­..."
	@if [ ! -f $(TF_DIR)/.terraform.lock.hcl ]; then \
		echo "TerraformãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¾ã™..."; \
		$(MAKE) ensure-terraform-backend-bucket-production; \
		cd $(TF_DIR) && terraform init; \
	fi
	@cd $(TF_DIR) && terraform fmt -recursive
	@echo "âœ… æœ¬ç•ªç’°å¢ƒã®Terraformãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"

terraform-validate-production: ## æœ¬ç•ªç’°å¢ƒã®Terraformãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼
	@echo "ğŸ” æœ¬ç•ªç’°å¢ƒã®Terraformãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼ä¸­..."
	@if [ ! -f $(TF_DIR)/.terraform.lock.hcl ]; then \
		echo "TerraformãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¾ã™..."; \
		$(MAKE) ensure-terraform-backend-bucket-production; \
		cd $(TF_DIR) && terraform init; \
	fi
	@cd $(TF_DIR) && terraform validate
	@echo "âœ… æœ¬ç•ªç’°å¢ƒã®Terraformæ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸ"